# pgvector + huggingface

### Postgres Database with PGVector
PostgresDB + pgvector is a combination of technologies that lets you store, search, and retrieve vector embeddings efficiently inside a PostgreSQL database. This allows us to combine structured and vector data in one place as well as providing us the ability to query vectors using familiar SQL syntax.

Fortunately for us, we can easily clone the latest docker image provided by the developers of pgvector (providing you have Docker Desktop installed, see https://www.docker.com/products/docker-desktop/):

```
docker pull pgvector/pgvector:pg17
```

Next we can run this container with some standard default parameters. We name the container, the database and provide simple username and password and stick to the default ports.

```
docker run -d \
  --name pgvector-db \
  -e POSTGRES_USER=postgres \
  -e POSTGRES_PASSWORD=postgres \
  -e POSTGRES_DB=vector_db \
  -p 5432:5432 \
  pgvector/pgvector:pg17
```

You can check to see if the docker container has been created by running the command where 'ps' stands for 'process status' and the '-a' means show all.

```
docker ps -a
```
Now that we know our docker image is running, we can connecxt ro rhe database and enable the pgvector extension. To connect to the database, we can use the 'psql' where we must provide the host (-h),  the username (-U) and the database name (-d).


```
psql -h localhost -U postgres -d vector_db
```

Now that we have connected to the database, we can run some commands on it to make sure it is working as expect. For example, we can start by enabling the pgvector extension in the database:

```
CREATE EXTENSION IF NOT EXISTS vector;
```

Finally we can create a table for our vectors.

```
CREATE TABLE documents (
  id SERIAL PRIMARY KEY,
  content TEXT,
  embedding VECTOR(384)
);
```

Next we need to populate our database with some vectors. There are obviously many ways to do this, but we will probably start by writing a python script to read our text files, embed them into a 384 dimensional vector space and store the embedded representation in our database.

For handling the python environment, we will use uv which is a fast and modern Python package manager and runtime developed by Astral.

```
curl -LsSf https://astral.sh/uv/install.sh | sh
```

Now uv is installed, we can create a new python environment. In our example, we are going to use python3.12, but older version will also be compatible.

```
uv venv --python 3.12
```

Activate our new environment using

```
source .venv/bin/activate
```

Next we can install the following module dependencies: 

```
uv pip install transformers accelerate bitsandbytes protobuf sentencepiece psycopg2-binary
```

Finally can populate the postgres database by running the python file populate_db.py.

```
python populate_db.py
```

We can check that the database is populated and functioning correctly by querying it will a sample vector. For example:

```
SELECT id, content
FROM documents
ORDER BY embedding <-> '[0.0418531559407711, 0.04099065810441971, 0.03857378289103508, 0.06034109368920326, 0.04622569680213928, -0.1387525349855423, -0.09548637270927429, -0.05682262405753136, -0.009007646702229977, 0.06853500008583069, 0.01643092930316925, -0.02697855420410633, -0.0008848475990816951, 0.04472639784216881, -0.014111161231994629, 0.039936263114213943, -0.022694936022162437, 0.008697700686752796, -0.059811852872371674, -0.021672826260328293, 0.07404518127441406, 0.05632329359650612, -0.004637142643332481, -0.06199472397565842, 0.02188613824546337, 0.03427558392286301, -0.14278320968151093, 0.04625239595770836, -0.018707504495978355, 0.014316387474536896, -0.02291666530072689, 0.05562421679496765, 0.052665550261735916, 0.05732981488108635, -0.05938451737165451, 0.07062374800443649, 0.013663012534379959, -0.11660638451576233, 0.05270325019955635, 0.015012279152870178, -0.05172133073210716, 0.04497550427913666, -0.00012413847434800118, -0.014298200607299805, -0.005094003863632679, 0.013834438286721706, 0.013639405369758606, 0.05080125853419304, 0.061475660651922226, -0.033616095781326294, 0.0696069672703743, -0.06423389911651611, -0.09017704427242279, -0.047579292207956314, -0.00243879365734756, 0.008778898976743221, -0.007839416153728962, -0.020777717232704163, 0.005329024512320757, 0.06361941248178482, -0.015726519748568535, 0.07128725200891495, -0.06834689527750015, 0.05958376079797745, 0.0411226712167263, -0.03080028109252453, -0.017344756051898003, -0.029002580791711807, -0.0028888501692563295, -0.014982519671320915, -0.08674746751785278, 0.048248372972011566, -0.08840130269527435, -0.05089311674237251, -0.07794810086488724, -0.030030712485313416, 0.04268643632531166, 0.0012089277151972055, -0.0014816016191616654, -0.09415200352668762, -0.009328397922217846, 0.03491706773638725, -0.008057666942477226, -0.011573308147490025, -0.02156318910419941, -0.009003648534417152, 0.01046702265739441, 0.14843083918094635, 0.004605690948665142, -0.008720376528799534, -0.007542339153587818, -0.06155348941683769, -0.04101663455367088, 0.04855962097644806, -0.11386112123727798, 0.04309011623263359, 0.03058444708585739, -0.05572979152202606, -0.05630642548203468, 0.003745525609701872, -0.034163884818553925, -0.005035048350691795, 0.025764763355255127, -0.045788511633872986, -0.02011852152645588, 0.030682949349284172, -0.11374016851186752, 0.0704297125339508, -0.094874307513237, 0.05519377440214157, 0.01049092784523964, 0.04012414067983627, 0.01725875400006771, 0.12146257609128952, 0.026810085400938988, 0.029666123911738396, 0.05203021317720413, 0.0067025283351540565, 0.01653922349214554, 0.08359808474779129, 0.04595980420708656, -0.04688717797398567, -0.028412863612174988, -0.019257063046097755, 0.0022341920994222164, 0.06271585077047348, 0.0335828922688961, -2.8626779028086628e-33, 0.03327580913901329, 0.003348761238157749, 0.04602286219596863, 0.01627013459801674, 0.05365268141031265, -0.045541875064373016, 0.007277883123606443, -0.058780424296855927, 0.06584113836288452, 0.07060496509075165, -0.010596422478556633, -0.06202569231390953, -0.023583628237247467, -0.032133784145116806, 0.04355888068675995, -0.015517785213887691, 0.04655952751636505, -0.014720901846885681, -0.057680968195199966, 0.016983766108751297, -0.050513558089733124, -0.12854602932929993, -0.07155489921569824, 0.03869916498661041, 0.0965588241815567, -0.11842107027769089, 0.07260904461145401, -0.045132048428058624, 0.0692598819732666, 0.0011070972541347146, 0.07906249165534973, -0.03320469707250595, -0.051621489226818085, 0.0032947459258139133, -0.015430829487740993, -0.00886253360658884, 0.0762297511100769, -0.028033288195729256, 0.04260007292032242, -0.050311971455812454, -0.0703817829489708, -0.0016033448046073318, 0.03082902356982231, -0.09059993177652359, -0.04196464642882347, -0.0006767677259631455, 0.025999384000897408, 0.07851648330688477, -0.06258368492126465, 0.04425334930419922, 0.03219439834356308, 0.043430302292108536, 0.004230482038110495, 0.02737579680979252, 0.032605722546577454, 0.05665825307369232, 0.07708403468132019, 0.012706790119409561, -0.02677416056394577, 0.11618221551179886, 0.03306860476732254, -0.018474476411938667, 0.016088226810097694, 0.019495796412229538, -0.04314315319061279, -0.011492962948977947, -0.027651110664010048, 0.05885150656104088, -0.041548289358615875, 0.04067583009600639, 0.04719685763120651, -0.037039726972579956, 0.022364800795912743, -0.05158549174666405, 0.044417232275009155, -0.0551176555454731, 0.06946294009685516, -0.0608382523059845, -0.07906827330589294, 0.10140971839427948, 0.04018377885222435, 0.05127958953380585, -0.07096003741025925, -0.041679807007312775, 0.08610747754573822, -0.04639303311705589, 0.02187328413128853, 0.0024046164471656084, -0.010715348646044731, -0.06046817824244499, -0.02400374971330166, 0.017434442415833473, -0.017921824008226395, -0.08195014297962189, -0.015828078612685204, 1.6055827545332075e-33, 0.05122882127761841, 0.01596060022711754, 0.08998706936836243, 0.020973503589630127, 0.02005978673696518, -0.013551993295550346, -0.10005766153335571, 0.049151044338941574, -0.038117665797472, -0.016946343705058098, -0.08274145424365997, 0.02381010167300701, -0.014095502905547619, -0.03218826651573181, 0.007403638679534197, -0.016962766647338867, 0.0843753069639206, -0.04717559367418289, -0.03857920318841934, 0.06662453711032867, 0.018806597217917442, 0.057357802987098694, 0.009157477878034115, -0.08009292930364609, -0.04628663510084152, -0.024594932794570923, -0.026990409940481186, 0.021597202867269516, -0.024797307327389717, 0.0005867581930942833, -0.022736147046089172, -0.08568406850099564, -0.0880272313952446, -0.00036528860800899565, 0.002888752380385995, -0.0214691124856472, -0.023680182173848152, 0.04775691777467728, 0.055111151188611984, 0.034264933317899704, 0.015582788735628128, -0.03959987312555313, -0.002488867612555623, -0.00852457620203495, -0.018053412437438965, -0.09092308580875397, -0.03475145250558853, -0.0625593513250351, 0.017229745164513588, 0.058644119650125504, 0.019434258341789246, 0.06953801959753036, 0.026513176038861275, -0.026170019060373306, 0.07550377398729324, -0.049745433032512665, 0.016344264149665833, -0.0861833393573761, -0.01786796934902668, -0.03648115694522858, -0.0419277623295784, 0.03380800038576126, -0.0023583779111504555, 0.041119545698165894, -0.042694464325904846, -0.009136532433331013, -0.023885754868388176, 0.01966620422899723, 0.010175557807087898, -0.02279876358807087, -0.12450654059648514, 0.02811875008046627, -0.015582927502691746, 0.006782245822250843, -0.02944592386484146, -0.07697345316410065, 0.021609118208289146, 0.02379593439400196, -0.008067118003964424, 0.0028754514642059803, 0.0047059571370482445, 0.1079535037279129, 0.03259080648422241, -0.06244939938187599, 0.014241543598473072, -0.02882010117173195, -0.003770324168726802, 0.011339928954839706, 0.12009945511817932, 0.022754982113838196, 0.07617716491222382, 0.08129746466875076, 0.07181107997894287, -0.008992222137749195, 0.03825182467699051, -1.8273384583267216e-08, -0.039158061146736145, 0.025671249255537987, 0.04423196613788605, -0.046775054186582565, 0.08819032460451126, 0.03722972795367241, 0.08779088407754898, 0.056956544518470764, -0.03865714371204376, -0.02287154644727707, 0.10885412245988846, 0.027412500232458115, 0.0631372481584549, 0.07948490232229233, -0.024423424154520035, -0.037537023425102234, 0.07012779265642166, -0.09172522276639938, -0.009939133189618587, 0.042671237140893936, 0.020544325932860374, 0.010161505080759525, -0.04448942467570305, 0.05823620408773422, 0.05252842977643013, -0.018385708332061768, -0.02016722783446312, -0.037319064140319824, -0.020105604082345963, 0.034768376499414444, -0.005637258756905794, 0.046418000012636185, -0.13442060351371765, 0.013073482550680637, -0.11205770075321198, -0.07215431332588196, -0.06257586181163788, 0.030162274837493896, -0.058504268527030945, 0.032324083149433136, -0.030549392104148865, 0.03096006251871586, 0.04923359677195549, 0.048532888293266296, -0.003479788778349757, -0.021022317931056023, -0.10508278757333755, 0.010203964076936245, 0.008360224775969982, 0.01708160527050495, 0.057313986122608185, 0.02226860634982586, 0.02330600656569004, 0.029264433309435844, 0.06068862974643707, 0.03232360631227493, -0.0003658458881545812, -0.04778870940208435, 0.01857614330947399, 0.014825222082436085, -0.02626928500831127, -0.10846657305955887, -0.06714833527803421, -0.0414944551885128]'
LIMIT 1;
```

As you can see, the database will return the id and the contents of the document talking about the garden.

Now we have a populated vector database, the next part of the process will be running a large language model locally. In this example, we are going to make use of the huggingface-cli. You can start by creating an account at https://huggingface.co/. Once you have logged in, you can go to a profile and generate a token which can be used to authenticate with the huggingface-cli.

Next run the command:

```
huggingface-cli login
```

And pass in the token generated in the browser.


First time running the code will take a while because and models will need to be installed on your machine.


